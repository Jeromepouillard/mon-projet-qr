<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>G√©n√©rateur de QR Code avec Logo</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      background: #f4f4f4;
      background-image: url("./honeycomb.png");
      background-repeat: repeat;
      background-size: auto;
    }
    .container {
      background: #fff;
      padding: 20px 40px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      text-align: center;
      max-width: 900px;
      width: 95%;
    }
    h1 {
      color: #333;
      margin-top: 0;
    }
    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
    }
    input#inputText,
    input#printTitle,
    input#printSubtitle {
      width: 100%;
      max-width: 640px;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 16px;
    }
    .maxnote {
      font-size: 12px;
      color: #777;
      margin-top: -6px;
      margin-bottom: 8px;
    }
    .option-logo-row {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: center;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .option-logo-row input[type="checkbox"] {
      margin-right: 5px;
    }
    button {
      background: #007bff;
      color: #fff;
      border: none;
      padding: 12px 20px;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.3s;
      margin: 5px;
    }
    button:hover {
      background: #0056b3;
    }
    #qrcode-container {
      margin-top: 20px;
      padding: 10px;
      border: 2px solid #eee;
      display: inline-block;
      background: #fff;
    }
    #qrcode-canvas {
      display: block;
    }

    #printTitlesContainer {
      text-align: center;
      margin-top: 10mm;
      margin-bottom: 10mm;
      display: none;
    }
    #printTitlePreview {
      font-size: 48pt;
      font-weight: bold;
      margin: 0;
      word-break: break-word;
      line-height: 1.2;
    }
    #printSubtitlePreview {
      font-size: 48pt;
      font-weight: normal;
      margin: 5mm 0 0 0;
      word-break: break-word;
      line-height: 1.2;
      color: #555;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>G√©n√©rateur de QR Code avec Logo</h1>

    <input type="text" id="inputText" placeholder="Entrez votre texte ou URL ici" />
    <div class="option-logo-row">
      <div style="display: flex; align-items: center;">
        <input type="checkbox" id="addLogo" />
        <label for="addLogo">Ajouter un logo au centre</label>
      </div>
      <input type="file" id="logoFile" accept="image/*" />
    </div>

    <div class="row" style="margin-top: 10px;">
      <input
        type="text"
        id="printTitle"
        placeholder="Titre principal √† imprimer (max 60 caract√®res)"
        maxlength="60"
      />
    </div>
    <div class="maxnote">
      <span id="titleCount">0</span>/60 caract√®res
    </div>
    
    <div class="row">
      <input
        type="text"
        id="printSubtitle"
        placeholder="Sous-titre √† imprimer (max 60 caract√®res)"
        maxlength="60"
      />
    </div>
    <div class="maxnote">
      <span id="subtitleCount">0</span>/60 caract√®res
    </div>

    <div class="row">
      <button onclick="generateQRCodeWithLogo()">G√©n√©rer le QR Code</button>
      <button onclick="printPage()">Imprimer (page actuelle)</button>
      <button onclick="downloadPDF()">T√©l√©charger en PDF (zone QR)</button>
      <button onclick="printWithTitle()">Imprimer avec Titre (A4, 15√ó15 cm)</button>
    </div>

    <div id="printTitlesContainer">
      <div id="printTitlePreview"></div>
      <div id="printSubtitlePreview"></div>
    </div>
    <div id="qrcode-container"></div>
  </div>

  <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

  <script>
    const printTitleEl = document.getElementById("printTitle");
    const printSubtitleEl = document.getElementById("printSubtitle");
    const titleCountEl = document.getElementById("titleCount");
    const subtitleCountEl = document.getElementById("subtitleCount");
    const printTitlesContainerEl = document.getElementById("printTitlesContainer");
    const printTitlePreviewEl = document.getElementById("printTitlePreview");
    const printSubtitlePreviewEl = document.getElementById("printSubtitlePreview");

    function updatePreview() {
      const mainTitle = printTitleEl.value;
      const subTitle = printSubtitleEl.value;
      titleCountEl.textContent = mainTitle.length.toString();
      subtitleCountEl.textContent = subTitle.length.toString();

      printTitlePreviewEl.textContent = mainTitle;
      printSubtitlePreviewEl.textContent = subTitle;

      if (mainTitle.trim() === "" && subTitle.trim() === "") {
        printTitlesContainerEl.style.display = "none";
      } else {
        printTitlesContainerEl.style.display = "block";
      }
    }

    printTitleEl.addEventListener("input", updatePreview);
    printSubtitleEl.addEventListener("input", updatePreview);

    function generateQRCodeWithLogo() {
        const text = document.getElementById("inputText").value;
        const addLogo = document.getElementById("addLogo").checked;
        const logoFile = document.getElementById("logoFile").files?.[0];
        const qrcodeContainer = document.getElementById("qrcode-container");
        
        const highResSize = 1500;
        const cssSize = 256;

        if (text.trim() === "") {
            alert("Veuillez entrer du texte ou une URL.");
            return;
        }

        qrcodeContainer.innerHTML = "";

        const tempCanvas = document.createElement("canvas");
        
        tempCanvas.width = highResSize;
        tempCanvas.height = highResSize;
        
        tempCanvas.style.width = cssSize + 'px';
        tempCanvas.style.height = cssSize + 'px';

        const tempContext = tempCanvas.getContext("2d");
        
        const qrDiv = document.createElement("div");
        const qrcode = new QRCode(qrDiv, {
            text,
            width: highResSize,
            height: highResSize,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H,
        });

        setTimeout(() => {
            const qrImg = qrDiv.querySelector("img");
            if (qrImg) {
                tempContext.imageSmoothingEnabled = false;
                tempContext.drawImage(qrImg, 0, 0, highResSize, highResSize);

                if (addLogo && logoFile) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const logoImg = new Image();
                        logoImg.onload = () => {
                            const logoSize = highResSize * 0.25;
                            const x = (highResSize - logoSize) / 2;
                            const y = (highResSize - logoSize) / 2;
                            
                            tempContext.save();
                            tempContext.imageSmoothingEnabled = true;
                            
                            tempContext.fillStyle = "#ffffff";
                            tempContext.fillRect(x - 5, y - 5, logoSize + 10, logoSize + 10);
                            tempContext.drawImage(logoImg, x, y, logoSize, logoSize);
                            
                            tempContext.restore();
                            
                            qrcodeContainer.appendChild(tempCanvas);
                        };
                        logoImg.src = event.target.result;
                    };
                    reader.readAsDataURL(logoFile);
                } else {
                    qrcodeContainer.appendChild(tempCanvas);
                }
            }
        }, 100);
    }

    function printPage() {
      window.print();
    }

    function downloadPDF() {
      const qrcodeContainer = document.getElementById("qrcode-container");
      if (qrcodeContainer.innerHTML.trim() === "") {
        alert("Veuillez d'abord g√©n√©rer un QR Code.");
        return;
      }
      const node = qrcodeContainer.firstChild;
      html2canvas(node).then((canvas) => {
        const imgData = canvas.toDataURL("image/png");
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF();
        const imgWidth = 60;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        pdf.addImage(imgData, "PNG", 75, 20, imgWidth, imgHeight);
        pdf.save("qrcode.pdf");
      });
    }

    function printWithTitle() {
      const qrcodeContainer = document.getElementById("qrcode-container");
      if (qrcodeContainer.innerHTML.trim() === "") {
        alert("G√©n√®re d'abord un QR Code üòâ");
        return;
      }

      const titre = (printTitleEl.value || "").trim();
      const sousTitre = (printSubtitleEl.value || "").trim();

      if (!titre && !sousTitre) {
        alert("Renseigne au moins un titre ou un sous-titre √† imprimer.");
        return;
      }

      const dataUrl = qrcodeContainer.querySelector("canvas")
        ? qrcodeContainer.querySelector("canvas").toDataURL("image/png")
        : qrcodeContainer.querySelector("img").src;

      const w = window.open("", "_blank");
      if (!w) {
        alert("Pop-up bloqu√©e. Autorise l'ouverture de fen√™tres.");
        return;
      }

      const titleHtml = titre ? `<h1>${escapeHtml(titre)}</h1>` : "";
      const subtitleHtml = sousTitre ? `<h2>${escapeHtml(sousTitre)}</h2>` : "";

      w.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="utf-8" />
          <title>Impression QR</title>
          <style>
            @page { size: A4; margin: 0; }
            html, body { height: 100%; }
            body { margin:0; font-family: Arial, sans-serif; display: flex; flex-direction: column; align-items: center; }
            .page {
              width: 210mm; height: 297mm;
              display:flex; flex-direction:column; align-items:center;
              justify-content:flex-start; page-break-after:avoid;
              padding-top: 10mm;
            }
            .titles-container {
              text-align: center;
              margin-bottom: 5mm;
            }
            h1 {
              font-size: 48pt;
              font-weight: bold;
              margin-bottom: 0;
            }
            h2 {
              font-size: 48pt;
              font-weight: normal;
              margin-top: 2mm;
              margin-bottom: 0;
              color: #555;
            }
            .qrwrap {
              display:flex; align-items:center; justify-content:center; flex:1; width:100%;
              margin-top: -40mm; /* ‚úÖ Remonte le QR code de 4cm */
            }
            img.qr { width:150mm; height:150mm; object-fit:contain; }
            .empty-rectangle {
              width: 150mm; /* M√™me largeur que le QR code */
              height: 40mm; /* Hauteur de 4cm */
              border: 1px solid #ccc; 
              margin-top: 5mm;
            }
            .page, .titles-container, .qrwrap, .empty-rectangle { break-inside: avoid; page-break-inside: avoid; }
          </style>
        </head>
        <body>
          <div class="page">
            <div class="titles-container">
              ${titleHtml}
              ${subtitleHtml}
            </div>
            <div class="qrwrap">
              <img class="qr" src="${dataUrl}" alt="QR Code" />
            </div>
            <div class="empty-rectangle"></div>
          </div>
          <script>window.onload = () => { setTimeout(()=>window.print(), 150); }<\/script>
        </body>
        </html>
      `);
      w.document.close();
    }

    function escapeHtml(s) {
      return s.replace(/[&<>"']/g, (c) => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        "\"": "&quot;",
        "'": "&#39;",
      })[c]);
    }
  </script>
</body>
</html>


